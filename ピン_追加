import streamlit as st
import folium
from streamlit_folium import st_folium

st.title("ğŸ—ºï¸ åœ°å›³å‹æ€ã„å‡ºæ—¥è¨˜")
st.caption("åœ°å›³ã®ä¸­å¤®ã«ãƒ”ãƒ³ã‚’ç«‹ã¦ã¦ã€ãã®å ´æ‰€ã«æ€ã„å‡ºã‚’è¨˜éŒ²ã—ã‚ˆã†ï¼")

# ãƒ¡ãƒ¢ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
memo_title = st.text_input("æ€ã„å‡ºã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›", "æ€ã„å‡ºã®å ´æ‰€")

# åˆæœŸä½ç½®ï¼ˆç¦å²¡ï¼‰ã®åœ°å›³ã‚’ä½œæˆ
m = folium.Map(location=[35, 135], zoom_start=5)

# ãƒ”ãƒ³ã®ä½ç½®ã‚’å–å¾—ã™ã‚‹é–¢æ•°
def get_pin_position(map_data):
    if map_data and 'last_clicked' in map_data:
        position = map_data['last_clicked']
        if position:
            return position['lat'], position['lng']
    return None

# ä»¥å‰ã®ä¿å­˜ã—ãŸãƒ”ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹
if "saved_pins" not in st.session_state:
    st.session_state.saved_pins = []

# ã™ã§ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ”ãƒ³ã‚’åœ°å›³ã«è¿½åŠ 
for pin_data in st.session_state.saved_pins:
    folium.Marker(
        location=pin_data['position'],
        popup=f"{pin_data['memo']}",
        icon=folium.Icon(color="blue"),
        draggable=False
    ).add_to(m)

# åˆæœŸã®ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ãªãƒ”ãƒ³
folium.Marker(
    [35, 135],
    popup=memo_title,
    icon=folium.Icon(color="red"),
    draggable=True
).add_to(m)

# åœ°å›³ã‚’è¡¨ç¤º
map_data = st_folium(m, width=700, height=500)

# ãƒ¡ãƒ¢ã‚’æ›¸ãã‚¨ãƒªã‚¢
memo = st.text_area("âœï¸ æ€ã„å‡ºãƒ¡ãƒ¢ã‚’æ›¸ã", "")

# ãƒ¡ãƒ¢ã‚’ä¿å­˜ã™ã‚‹ãƒœã‚¿ãƒ³
if st.button("âœ… ç™»éŒ²"):
    pin_position = get_pin_position(map_data)
    if pin_position:
        # æ–°ã—ã„ãƒ”ãƒ³ã‚’ä¿å­˜
        new_pin = {"title": memo_title, "position": pin_position, "memo": memo}
        st.session_state.saved_pins.append(new_pin)
        
        st.success(
            f"æ€ã„å‡ºã‚’ä¿å­˜ã—ã¾ã—ãŸï¼\nã‚¿ã‚¤ãƒˆãƒ«: {memo_title}\nå ´æ‰€: ç·¯åº¦ {pin_position[0]}, çµŒåº¦ {pin_position[1]}\nãƒ¡ãƒ¢: {memo}"
        )

        # åœ°å›³ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æ›´æ–°ã•ã‚ŒãŸãƒ”ãƒ³ã‚’è¡¨ç¤º
        st.rerun()
    else:
        st.warning("ãƒ”ãƒ³ã®ä½ç½®ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚")

# ãƒ”ãƒ³ã‚’å‰Šé™¤ã™ã‚‹ãŸã‚ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹
delete_pin_title = st.selectbox("å‰Šé™¤ã™ã‚‹ãƒ”ãƒ³ã‚’é¸æŠ", [pin['title'] for pin in st.session_state.saved_pins])

# ãƒ”ãƒ³ã‚’å‰Šé™¤ã™ã‚‹ãƒœã‚¿ãƒ³
if st.button("âŒ å‰Šé™¤"):
    st.session_state.saved_pins = [pin for pin in st.session_state.saved_pins if pin['title'] != delete_pin_title]
    st.success(f"ãƒ”ãƒ³ '{delete_pin_title}' ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚")
    st.rerun()
